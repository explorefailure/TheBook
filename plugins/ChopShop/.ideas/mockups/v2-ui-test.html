<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ChopShop UI Mockup v2 - Modular Cable Patching</title>

  <style>
    /* CRITICAL: WebView constraints */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      /* Native application feel */
      user-select: none;
      -webkit-user-select: none;
      cursor: default;
      overflow: hidden;

      /* Test frame centering */
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      font-family: Arial, sans-serif;
    }

    /* Fixed-size preview frame matching plugin spec */
    .plugin-frame {
      width: 650px;
      height: 350px;
      border: 2px solid #b87333;
      box-shadow: 0 10px 40px rgba(0,0,0,0.8);
      overflow: hidden;
      position: relative;
    }

    /* Plugin UI container */
    .container {
      width: 100%;
      height: 100%;
      position: relative;
      background: linear-gradient(135deg, #1a1d1a 0%, #0d0f0d 100%);
    }

    /* Weathered metal background with patina */
    .background-texture {
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 30% 40%, rgba(75, 107, 82, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 70% 60%, rgba(75, 107, 82, 0.1) 0%, transparent 50%),
        linear-gradient(180deg, rgba(45, 58, 45, 0.3) 0%, transparent 100%);
      pointer-events: none;
      z-index: 1;
    }

    /* Rivets decoration */
    .rivet {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #3d3d3d, #0d0f0d);
      box-shadow:
        inset -1px -1px 2px rgba(0,0,0,0.8),
        inset 1px 1px 1px rgba(255,255,255,0.1);
      z-index: 2;
    }

    /* Googie atomic age accent curves */
    .googie-accent {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 3px solid rgba(91, 192, 190, 0.2);
      pointer-events: none;
      z-index: 2;
    }

    /* Title - stencil lettering */
    .title {
      position: absolute;
      left: 25px;
      top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 20px;
      font-weight: bold;
      color: #fde8cd;
      letter-spacing: 3px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      z-index: 10;
    }

    /* MODULAR PATCH BAY SECTION */
    .patch-bay {
      position: absolute;
      left: 15px;
      top: 50px;
      width: 620px;
      height: 80px;
      z-index: 5;
    }

    /* Effect module */
    .module {
      position: absolute;
      width: 90px;
      height: 60px;
      background: linear-gradient(135deg, #2d3a2d, #1a1d1a);
      border: 2px solid #b87333;
      border-radius: 4px;
      box-shadow:
        inset -2px -2px 4px rgba(0,0,0,0.4),
        inset 2px 2px 4px rgba(255,255,255,0.05),
        0 4px 8px rgba(0,0,0,0.6);
      z-index: 8;
    }

    .module-label {
      position: absolute;
      top: 4px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 9px;
      font-weight: bold;
      color: #fde8cd;
      letter-spacing: 0.5px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }

    /* Mini module knob */
    .mini-knob {
      position: absolute;
      top: 22px;
      left: 33px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #2d3a2d, #1a1d1a);
      cursor: pointer;
      transition: transform 0.05s ease-out;
      transform-origin: center center;
      box-shadow:
        inset -2px -2px 3px rgba(0,0,0,0.6),
        inset 1px 1px 2px rgba(255,255,255,0.1);
    }

    .mini-knob-indicator {
      position: absolute;
      top: 3px;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 6px;
      background: #5bc0be;
      border-radius: 1px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.6);
    }

    /* Jack (connection point) */
    .jack {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #d4a373, #b87333);
      border: 2px solid #8b5a2b;
      cursor: pointer;
      z-index: 10;
      transition: box-shadow 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.6);
    }

    .jack:hover {
      box-shadow: 0 0 8px rgba(91, 192, 190, 0.6);
    }

    .jack.active {
      box-shadow: 0 0 12px rgba(255, 107, 53, 0.8);
    }

    .jack-label {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 8px;
      color: #fde8cd;
      white-space: nowrap;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }

    /* Cable SVG layer */
    .cables-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 6;
    }

    .cable {
      stroke-width: 3;
      stroke-linecap: round;
      fill: none;
      opacity: 0.85;
      transition: stroke-width 0.2s, opacity 0.2s;
      pointer-events: stroke;
      cursor: pointer;
    }

    .cable:hover {
      stroke-width: 5;
      opacity: 1;
      filter: drop-shadow(0 0 4px rgba(255,255,255,0.6));
    }

    .cable.dragging {
      stroke-dasharray: 5, 5;
      animation: dash 0.5s linear infinite;
    }

    @keyframes dash {
      to {
        stroke-dashoffset: -10;
      }
    }

    /* Bakelite knob styling */
    .knob {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 10;
    }

    .knob-body {
      position: relative;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #4a6b52, #2d3a2d);
      cursor: pointer;
      transition: transform 0.05s ease-out;
      transform-origin: center center;
    }

    /* Bakelite ridges texture */
    .knob-body::before {
      content: '';
      position: absolute;
      inset: 8%;
      border-radius: 50%;
      background:
        repeating-conic-gradient(
          from 0deg,
          transparent 0deg,
          transparent 4deg,
          rgba(0,0,0,0.15) 4deg,
          rgba(0,0,0,0.15) 5deg
        );
      pointer-events: none;
    }

    /* Fixed lighting layer (doesn't rotate) */
    .knob-lighting {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      box-shadow:
        inset -3px -3px 6px rgba(0,0,0,0.6),
        inset 3px 3px 6px rgba(255,255,255,0.1);
      pointer-events: none;
      z-index: 2;
    }

    /* Brass/copper indicator (rotates with body) */
    .knob-indicator {
      position: absolute;
      top: 12%;
      left: 50%;
      transform: translateX(-50%);
      width: 3px;
      height: 25%;
      background: linear-gradient(180deg, #b87333, #8b5a2b);
      border-radius: 2px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.6);
    }

    .knob-label {
      margin-top: 8px;
      font-size: 11px;
      color: #fde8cd;
      letter-spacing: 1px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }

    .knob-value {
      margin-top: 2px;
      font-size: 13px;
      color: #b87333;
      font-family: 'Courier New', monospace;
    }

    /* Hero knob - large central control */
    .knob-hero .knob-body {
      width: 120px;
      height: 120px;
    }

    .knob-hero .knob-indicator {
      height: 28%;
      width: 4px;
    }

    /* Small knob */
    .knob-small .knob-body {
      width: 70px;
      height: 70px;
    }

    .knob-small .knob-indicator {
      height: 22%;
    }

    /* Atomic age toggle switch */
    .toggle {
      position: absolute;
      width: 50px;
      height: 30px;
      z-index: 10;
    }

    .toggle-track {
      width: 100%;
      height: 100%;
      background: #1a1d1a;
      border: 2px solid #4a6b52;
      border-radius: 15px;
      position: relative;
      cursor: pointer;
      transition: border-color 0.3s;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.6);
    }

    .toggle-track.active {
      border-color: #5bc0be;
    }

    .toggle-handle {
      position: absolute;
      top: 3px;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle at 35% 35%, #d4a373, #b87333);
      border-radius: 50%;
      transition: left 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.6);
    }

    .toggle-track:not(.active) .toggle-handle {
      left: 3px;
    }

    .toggle-track.active .toggle-handle {
      left: 23px;
    }

    .toggle-label {
      position: absolute;
      top: 35px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 9px;
      color: #fde8cd;
      letter-spacing: 0.5px;
    }

    /* Mechanical selector (combo box) */
    .selector {
      position: absolute;
      z-index: 10;
    }

    .selector-button {
      width: 130px;
      height: 35px;
      background: linear-gradient(180deg, #2d3a2d, #1a1d1a);
      border: 2px solid #b87333;
      border-radius: 4px;
      color: #fde8cd;
      font-size: 11px;
      font-weight: bold;
      padding: 0 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      box-shadow:
        inset -1px -1px 2px rgba(0,0,0,0.4),
        0 2px 4px rgba(0,0,0,0.6);
    }

    .selector-button:hover {
      border-color: #5bc0be;
    }

    .selector-arrow {
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 5px solid #b87333;
    }

    .selector-label {
      position: absolute;
      top: 40px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 9px;
      color: #fde8cd;
      letter-spacing: 0.5px;
    }

    /* Debug monitor (test only) */
    .debug-monitor {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.9);
      color: #5bc0be;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      padding: 10px 14px;
      border: 2px solid #b87333;
      border-radius: 4px;
      min-width: 200px;
      pointer-events: none;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.8);
    }

    .debug-label {
      color: #b87333;
      font-size: 9px;
      margin-bottom: 6px;
      letter-spacing: 1px;
    }

    .debug-param {
      font-weight: bold;
      color: #5bc0be;
    }

    .debug-value {
      color: #fde8cd;
      margin-top: 3px;
    }

    .debug-normalized {
      color: #888;
      font-size: 10px;
      margin-top: 2px;
    }

    .debug-cables {
      color: #ff6b35;
      font-size: 10px;
      margin-top: 6px;
      border-top: 1px solid #333;
      padding-top: 4px;
    }
  </style>
</head>
<body>
  <div class="plugin-frame">
    <div class="container">
      <!-- Background texture -->
      <div class="background-texture"></div>

      <!-- Rivets decoration -->
      <div class="rivet" style="left: 15px; top: 20px;"></div>
      <div class="rivet" style="right: 15px; top: 20px;"></div>
      <div class="rivet" style="left: 15px; bottom: 20px;"></div>
      <div class="rivet" style="right: 15px; bottom: 20px;"></div>

      <!-- Googie atomic accents -->
      <div class="googie-accent" style="right: -20px; top: -20px;"></div>
      <div class="googie-accent" style="left: -30px; bottom: -30px;"></div>

      <!-- Title -->
      <div class="title">CHOPSHOP</div>

      <!-- Cables layer (drawn below jacks but above background) -->
      <svg class="cables-layer" id="cablesLayer" xmlns="http://www.w3.org/2000/svg">
        <!-- Cables will be dynamically rendered here -->
      </svg>

      <!-- MODULAR PATCH BAY -->
      <div class="patch-bay">
        <!-- Main IN jack -->
        <div class="jack" id="jack-main-in" data-jack="main_in" data-type="output" style="left: 15px; top: 30px;">
          <div class="jack-label">IN</div>
        </div>

        <!-- STUTTER MODULE -->
        <div class="module" style="left: 105px; top: 10px;">
          <div class="module-label">STUTTER</div>
          <div class="jack" id="jack-stutter-in" data-jack="stutter_in" data-type="input" style="left: -6px; top: 24px;"></div>
          <div class="jack" id="jack-stutter-out" data-jack="stutter_out" data-type="output" style="right: -6px; top: 24px;"></div>
          <div class="mini-knob" data-param="stutter_intensity" data-min="0" data-max="1" data-value="1">
            <div class="mini-knob-indicator"></div>
          </div>
        </div>

        <!-- PITCH MODULE -->
        <div class="module" style="left: 215px; top: 10px;">
          <div class="module-label">PITCH</div>
          <div class="jack" id="jack-pitch-in" data-jack="pitch_in" data-type="input" style="left: -6px; top: 24px;"></div>
          <div class="jack" id="jack-pitch-out" data-jack="pitch_out" data-type="output" style="right: -6px; top: 24px;"></div>
          <div class="mini-knob" data-param="pitch_shift" data-min="-24" data-max="24" data-value="0">
            <div class="mini-knob-indicator"></div>
          </div>
        </div>

        <!-- SPEED MODULE -->
        <div class="module" style="left: 325px; top: 10px;">
          <div class="module-label">SPEED</div>
          <div class="jack" id="jack-speed-in" data-jack="speed_in" data-type="input" style="left: -6px; top: 24px;"></div>
          <div class="jack" id="jack-speed-out" data-jack="speed_out" data-type="output" style="right: -6px; top: 24px;"></div>
          <div class="mini-knob" data-param="speed" data-min="50" data-max="200" data-value="100">
            <div class="mini-knob-indicator"></div>
          </div>
        </div>

        <!-- REVERSE MODULE -->
        <div class="module" style="left: 435px; top: 10px;">
          <div class="module-label">REVERSE</div>
          <div class="jack" id="jack-reverse-in" data-jack="reverse_in" data-type="input" style="left: -6px; top: 24px;"></div>
          <div class="jack" id="jack-reverse-out" data-jack="reverse_out" data-type="output" style="right: -6px; top: 24px;"></div>
          <div class="mini-knob" data-param="reverse_mix" data-min="0" data-max="100" data-value="100">
            <div class="mini-knob-indicator"></div>
          </div>
        </div>

        <!-- Main OUT jack -->
        <div class="jack" id="jack-main-out" data-jack="main_out" data-type="input" style="right: 15px; top: 30px;">
          <div class="jack-label">OUT</div>
        </div>
      </div>

      <!-- CENTER: Stutter Rate - Large hero knob -->
      <div class="knob knob-hero" style="left: 265px; top: 155px;" data-param="stutter_rate" data-choices='["1/1", "1/2", "1/4", "1/8", "1/16", "1/32", "1/64"]' data-value="3">
        <div class="knob-body" id="knob-stutter-rate">
          <div class="knob-indicator"></div>
          <div class="knob-lighting"></div>
        </div>
        <div class="knob-label">STUTTER RATE</div>
        <div class="knob-value" id="value-stutter-rate">1/8</div>
      </div>

      <!-- BOTTOM LEFT: Link and Trigger -->

      <!-- Link Toggle -->
      <div class="toggle" style="left: 30px; top: 285px;" data-param="link_pitch_speed" data-value="false">
        <div class="toggle-track" id="toggle-link-pitch-speed">
          <div class="toggle-handle"></div>
        </div>
        <div class="toggle-label">LINK P/S</div>
      </div>

      <!-- Trigger Mode Selector -->
      <div class="selector" style="left: 100px; top: 280px;" data-param="trigger_mode" data-choices='["Always", "MIDI", "Threshold"]' data-value="0">
        <div class="selector-button" id="selector-trigger-mode">
          <span id="value-trigger-mode">Always</span>
          <div class="selector-arrow"></div>
        </div>
        <div class="selector-label">TRIGGER MODE</div>
      </div>

      <!-- BOTTOM RIGHT: Threshold and Mix -->

      <!-- Threshold Knob -->
      <div class="knob knob-small" style="left: 460px; top: 270px;" data-param="threshold" data-min="-60" data-max="0" data-value="-20">
        <div class="knob-body" id="knob-threshold">
          <div class="knob-indicator"></div>
          <div class="knob-lighting"></div>
        </div>
        <div class="knob-label">THRESHOLD</div>
        <div class="knob-value" id="value-threshold">-20 dB</div>
      </div>

      <!-- Mix Knob -->
      <div class="knob knob-small" style="left: 550px; top: 270px;" data-param="mix" data-min="0" data-max="100" data-value="100">
        <div class="knob-body" id="knob-mix">
          <div class="knob-indicator"></div>
          <div class="knob-lighting"></div>
        </div>
        <div class="knob-label">MIX</div>
        <div class="knob-value" id="value-mix">100%</div>
      </div>
    </div>
  </div>

  <!-- Debug monitor -->
  <div class="debug-monitor">
    <div class="debug-label">PARAMETER MONITOR</div>
    <div class="debug-param" id="debugParam">—</div>
    <div class="debug-value" id="debugValue">—</div>
    <div class="debug-normalized" id="debugNormalized">—</div>
    <div class="debug-cables" id="debugCables">Signal: —</div>
  </div>

  <script>
    // Mock JUCE backend for browser testing
    window.Juce = {
      getSliderState: (id) => ({
        normalisedValue: 0.5,
        getNormalisedValue: () => 0.5,
        setNormalisedValue: (v) => console.log(`${id} set to ${v}`),
        valueChangedEvent: {
          addListener: (fn) => console.log(`Listener added for ${id}`)
        }
      }),
      getToggleState: (id) => ({
        value: false,
        valueChangedEvent: {
          addListener: (fn) => console.log(`Listener added for ${id}`)
        }
      }),
      getComboBoxState: (id) => ({
        selectedId: 0,
        valueChangedEvent: {
          addListener: (fn) => console.log(`Listener added for ${id}`)
        }
      })
    };

    // Disable context menu (REQUIRED)
    document.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      return false;
    });

    // Debug monitor update
    function updateDebugMonitor(paramId, value, normalizedValue) {
      document.getElementById('debugParam').textContent = paramId;
      document.getElementById('debugValue').textContent = value;
      document.getElementById('debugNormalized').textContent = `${(normalizedValue * 100).toFixed(1)}%`;
    }

    // MODULAR CABLE SYSTEM
    const cables = [];
    const cableColors = ['#5bc0be', '#ff6b35', '#d4a373'];
    let nextColorIndex = 0;
    let draggedCable = null;
    let dragStartJack = null;

    // Default cable connections (from YAML)
    const defaultConnections = [
      { from: 'main_in', to: 'stutter_in', color: '#5bc0be' },
      { from: 'stutter_out', to: 'pitch_in', color: '#ff6b35' },
      { from: 'pitch_out', to: 'speed_in', color: '#5bc0be' },
      { from: 'speed_out', to: 'reverse_in', color: '#ff6b35' },
      { from: 'reverse_out', to: 'main_out', color: '#d4a373' }
    ];

    function getJackPosition(jackId) {
      const jack = document.getElementById('jack-' + jackId);
      if (!jack) return null;
      const rect = jack.getBoundingClientRect();
      const containerRect = document.querySelector('.container').getBoundingClientRect();
      return {
        x: rect.left + rect.width / 2 - containerRect.left,
        y: rect.top + rect.height / 2 - containerRect.top
      };
    }

    function createCatenaryPath(x1, y1, x2, y2) {
      // Calculate catenary curve (natural hanging cable)
      const dx = x2 - x1;
      const dy = y2 - y1;
      const dist = Math.sqrt(dx * dx + dy * dy);

      // Control point for quadratic bezier (creates droop)
      const sagFactor = 0.3;
      const midX = (x1 + x2) / 2;
      const midY = (y1 + y2) / 2;
      const controlY = midY + Math.abs(dx) * sagFactor;

      return `M ${x1} ${y1} Q ${midX} ${controlY}, ${x2} ${y2}`;
    }

    function drawCables() {
      const svg = document.getElementById('cablesLayer');
      svg.innerHTML = '';

      cables.forEach((cable, index) => {
        const fromPos = getJackPosition(cable.from);
        const toPos = getJackPosition(cable.to);

        if (!fromPos || !toPos) return;

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', createCatenaryPath(fromPos.x, fromPos.y, toPos.x, toPos.y));
        path.setAttribute('stroke', cable.color);
        path.classList.add('cable');
        path.dataset.cableIndex = index;

        // Click to delete cable
        path.addEventListener('click', (e) => {
          e.stopPropagation();
          cables.splice(index, 1);
          drawCables();
          updateSignalPath();
          console.log(`Cable deleted: ${cable.from} → ${cable.to}`);
        });

        // Make pointer events work
        path.style.pointerEvents = 'stroke';

        svg.appendChild(path);
      });

      // Draw dragging cable preview
      if (draggedCable) {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', createCatenaryPath(
          draggedCable.x1,
          draggedCable.y1,
          draggedCable.x2,
          draggedCable.y2
        ));
        path.setAttribute('stroke', draggedCable.color);
        path.classList.add('cable', 'dragging');
        path.style.pointerEvents = 'none';
        svg.appendChild(path);
      }
    }

    function updateSignalPath() {
      // Trace signal path from main_in to main_out
      const path = ['IN'];
      let currentJack = 'main_in';
      const visited = new Set();

      while (currentJack !== 'main_out' && !visited.has(currentJack)) {
        visited.add(currentJack);
        const cable = cables.find(c => c.from === currentJack);
        if (!cable) break;

        currentJack = cable.to;
        const jackName = currentJack.replace('_in', '').replace('_out', '').toUpperCase();
        if (currentJack !== 'main_out') {
          path.push(jackName);
        }
      }

      if (currentJack === 'main_out') {
        path.push('OUT');
      }

      document.getElementById('debugCables').textContent = 'Signal: ' + path.join(' → ');
    }

    // Initialize default cables
    defaultConnections.forEach(conn => {
      cables.push({
        from: conn.from,
        to: conn.to,
        color: conn.color
      });
    });

    // Jack interaction
    document.querySelectorAll('.jack').forEach(jack => {
      jack.addEventListener('mousedown', (e) => {
        e.preventDefault();
        const jackId = jack.dataset.jack;
        const jackType = jack.dataset.type;

        // Only start drag from output jacks
        if (jackType !== 'output') return;

        const pos = getJackPosition(jackId);
        dragStartJack = jackId;
        draggedCable = {
          x1: pos.x,
          y1: pos.y,
          x2: pos.x,
          y2: pos.y,
          color: cableColors[nextColorIndex % cableColors.length]
        };

        jack.classList.add('active');
        console.log(`Cable drag started from: ${jackId}`);
      });
    });

    document.addEventListener('mousemove', (e) => {
      if (!draggedCable) return;

      const containerRect = document.querySelector('.container').getBoundingClientRect();
      draggedCable.x2 = e.clientX - containerRect.left;
      draggedCable.y2 = e.clientY - containerRect.top;
      drawCables();
    });

    document.addEventListener('mouseup', (e) => {
      if (!draggedCable) return;

      // Check if released on a jack
      const targetJack = e.target.closest('.jack');

      if (targetJack && targetJack.dataset.type === 'input') {
        const toJackId = targetJack.dataset.jack;

        // Create cable connection
        cables.push({
          from: dragStartJack,
          to: toJackId,
          color: draggedCable.color
        });

        nextColorIndex++;
        console.log(`Cable connected: ${dragStartJack} → ${toJackId}`);
        updateSignalPath();
      } else {
        console.log('Cable drag cancelled');
      }

      // Clean up
      document.querySelectorAll('.jack.active').forEach(j => j.classList.remove('active'));
      draggedCable = null;
      dragStartJack = null;
      drawCables();
    });

    // Initial draw
    drawCables();
    updateSignalPath();

    // Knob rotation logic
    function initKnob(knobElement) {
      const knobBody = knobElement.querySelector('.knob-body');
      const paramId = knobElement.dataset.param;
      const choices = knobElement.dataset.choices ? JSON.parse(knobElement.dataset.choices) : null;
      const min = choices ? 0 : parseFloat(knobElement.dataset.min || 0);
      const max = choices ? choices.length - 1 : parseFloat(knobElement.dataset.max || 1);
      let value = parseFloat(knobElement.dataset.value || 0);

      const valueDisplay = document.getElementById(`value-${paramId}`);

      function updateKnob(newValue) {
        value = Math.max(min, Math.min(max, newValue));
        const normalized = (value - min) / (max - min);
        const degrees = -135 + (normalized * 270);

        // Rotate entire knob body (not just indicator)
        knobBody.style.transform = `rotate(${degrees}deg)`;

        // Update value display
        if (choices) {
          valueDisplay.textContent = choices[Math.round(value)];
        } else {
          const unit = knobElement.dataset.unit || '';
          valueDisplay.textContent = `${value.toFixed(1)} ${unit}`.trim();
        }

        updateDebugMonitor(paramId, valueDisplay.textContent, normalized);
        console.log(`${paramId}: ${value} (${(normalized * 100).toFixed(1)}%)`);
      }

      let isDragging = false;
      let startY = 0;
      let startValue = value;

      knobBody.addEventListener('mousedown', (e) => {
        isDragging = true;
        startY = e.clientY;
        startValue = value;
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const deltaY = startY - e.clientY;
        const range = max - min;
        const sensitivity = choices ? 0.03 : 0.005;
        let newValue = startValue + (deltaY * range * sensitivity);
        if (choices) {
          newValue = Math.round(newValue);
        }
        updateKnob(newValue);
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
      });

      knobBody.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -1 : 1;
        const step = choices ? 1 : (max - min) / 100;
        updateKnob(value + (delta * step));
      });

      updateKnob(value);
    }

    // Mini knob rotation logic
    function initMiniKnob(miniKnobElement) {
      const paramId = miniKnobElement.dataset.param;
      const min = parseFloat(miniKnobElement.dataset.min || 0);
      const max = parseFloat(miniKnobElement.dataset.max || 1);
      let value = parseFloat(miniKnobElement.dataset.value || 0);

      function updateMiniKnob(newValue) {
        value = Math.max(min, Math.min(max, newValue));
        const normalized = (value - min) / (max - min);
        const degrees = -135 + (normalized * 270);

        miniKnobElement.style.transform = `rotate(${degrees}deg)`;
        console.log(`${paramId}: ${value.toFixed(1)}`);
      }

      let isDragging = false;
      let startY = 0;
      let startValue = value;

      miniKnobElement.addEventListener('mousedown', (e) => {
        isDragging = true;
        startY = e.clientY;
        startValue = value;
        e.preventDefault();
        e.stopPropagation();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const deltaY = startY - e.clientY;
        const range = max - min;
        const sensitivity = 0.01;
        updateMiniKnob(startValue + (deltaY * range * sensitivity));
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
      });

      updateMiniKnob(value);
    }

    // Toggle switch logic
    function initToggle(toggleElement) {
      const track = toggleElement.querySelector('.toggle-track');
      const paramId = toggleElement.dataset.param;
      let active = toggleElement.dataset.value === 'true';

      function updateToggle() {
        if (active) {
          track.classList.add('active');
        } else {
          track.classList.remove('active');
        }
        updateDebugMonitor(paramId, active ? 'ON' : 'OFF', active ? 1.0 : 0.0);
        console.log(`${paramId}: ${active}`);
      }

      track.addEventListener('click', () => {
        active = !active;
        updateToggle();
      });

      updateToggle();
    }

    // Selector (combo box) logic
    function initSelector(selectorElement) {
      const button = selectorElement.querySelector('.selector-button');
      const valueDisplay = document.getElementById(`value-${selectorElement.dataset.param}`);
      const paramId = selectorElement.dataset.param;
      const choices = JSON.parse(selectorElement.dataset.choices);
      let selectedIndex = parseInt(selectorElement.dataset.value || 0);

      function updateSelector() {
        valueDisplay.textContent = choices[selectedIndex];
        const normalized = selectedIndex / (choices.length - 1);
        updateDebugMonitor(paramId, choices[selectedIndex], normalized);
        console.log(`${paramId}: ${choices[selectedIndex]} (${selectedIndex})`);
      }

      button.addEventListener('click', () => {
        selectedIndex = (selectedIndex + 1) % choices.length;
        updateSelector();
      });

      updateSelector();
    }

    // Initialize all controls
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize main knobs
      document.querySelectorAll('.knob').forEach(initKnob);

      // Initialize mini module knobs
      document.querySelectorAll('.mini-knob').forEach(initMiniKnob);

      // Initialize toggles
      document.querySelectorAll('.toggle').forEach(initToggle);

      // Initialize selectors
      document.querySelectorAll('.selector').forEach(initSelector);

      console.log('ChopShop v2 UI mockup loaded - Modular cable patching system');
      console.log('Click output jacks and drag to input jacks to create cables');
      console.log('Click cables to delete them');
    });
  </script>
</body>
</html>
